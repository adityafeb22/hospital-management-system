<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Jahnavi's Hospital Management System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-small {
            width: auto;
            padding: 8px 20px;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .dashboard {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .dashboard-header h2 {
            color: #333;
            font-size: 28px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .card {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .stat-card p {
            font-size: 32px;
            font-weight: bold;
        }
        
        .patient-list {
            display: grid;
            gap: 15px;
        }
        
        .patient-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .patient-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .patient-item h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .patient-item p {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .modal-header h3 {
            color: #333;
            font-size: 24px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
        }
        
        .info-value {
            color: #333;
        }
        
        .upi-section {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .upi-section h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .upi-id {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .billing-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .billing-summary-card {
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .billing-summary-card.total {
            background: #f0f4ff;
            border: 1px solid #c7d2fe;
        }

        .billing-summary-card.paid {
            background: #f0fdf4;
            border: 1px solid #86efac;
        }

        .billing-summary-card.pending {
            background: #fff7ed;
            border: 2px solid #fdba74;
        }

        .billing-summary-card .summary-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .billing-summary-card.total .summary-label { color: #4f46e5; }
        .billing-summary-card.paid .summary-label  { color: #16a34a; }
        .billing-summary-card.pending .summary-label { color: #ea580c; }

        .billing-summary-card .summary-amount {
            font-size: 22px;
            font-weight: 700;
        }

        .billing-summary-card.total .summary-amount  { color: #4f46e5; }
        .billing-summary-card.paid .summary-amount   { color: #16a34a; }
        .billing-summary-card.pending .summary-amount { color: #ea580c; }

        .fee-row {
            background: white;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 10px;
            border: 1.5px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .fee-row.pending-row {
            border-color: #fdba74;
            background: #fffbf5;
        }

        .fee-row.paid-row {
            border-color: #86efac;
            background: #f8fff9;
        }

        .fee-row-left {
            flex: 1;
        }

        .fee-service {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .fee-date {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .fee-method {
            font-size: 12px;
            color: #6b7280;
        }

        .fee-row-right {
            text-align: right;
        }

        .fee-amount {
            font-size: 20px;
            font-weight: 700;
            color: #374151;
        }

        .fee-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .fee-badge.paid   { background: #dcfce7; color: #15803d; }
        .fee-badge.pending { background: #ffedd5; color: #c2410c; }

        .billing-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .billing-section-header h3 {
            color: #1f2937;
        }

        .billing-filter {
            display: flex;
            gap: 6px;
        }

        .filter-btn {
            padding: 5px 12px;
            border: 1.5px solid #e5e7eb;
            border-radius: 20px;
            background: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }

        .empty-billing {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .empty-billing p {
            font-size: 15px;
            margin-top: 8px;
        }

        .pending-alert {
            background: #fff7ed;
            border: 1.5px solid #fdba74;
            border-radius: 10px;
            padding: 14px 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #92400e;
            font-size: 14px;
            font-weight: 500;
        }
        
        .queue-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .queue-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .error-message {
            background: #ffe0e0;
            color: #d32f2f;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #d32f2f;
        }
        
        .success-message {
            background: #e0ffe0;
            color: #2f7d32;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #2f7d32;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_URL = window.location.origin + '/api';

        // API Helper Functions
        const api = {
            async login(email, password, role) {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, role })
                });
                if (!res.ok) throw new Error((await res.json()).error);
                return res.json();
            },

            async getPatients(token) {
                const res = await fetch(`${API_URL}/patients`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to fetch patients');
                return res.json();
            },

            async addPatient(token, data) {
                const res = await fetch(`${API_URL}/patients`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error((await res.json()).error);
                return res.json();
            },

            async updatePatient(token, id, data) {
                const res = await fetch(`${API_URL}/patients/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Failed to update patient');
                return res.json();
            },

            async deletePatient(token, id) {
                const res = await fetch(`${API_URL}/patients/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to delete patient');
                return res.json();
            },

            async getAppointments(token) {
                const res = await fetch(`${API_URL}/appointments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to fetch appointments');
                return res.json();
            },

            async addAppointment(token, data) {
                const res = await fetch(`${API_URL}/appointments`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Failed to add appointment');
                return res.json();
            },

            async getFees(token) {
                const res = await fetch(`${API_URL}/fees`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to fetch fees');
                return res.json();
            },

            async addFee(token, data) {
                const res = await fetch(`${API_URL}/fees`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Failed to add fee');
                return res.json();
            }
        };

        const App = () => {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('user') || 'null'));
            const [activeTab, setActiveTab] = useState('dashboard');
            const [patients, setPatients] = useState([]);
            const [appointments, setAppointments] = useState([]);
            const [fees, setFees] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [formData, setFormData] = useState({});
            const [billingFilter, setBillingFilter] = useState('all');

            useEffect(() => {
                if (token && user) {
                    loadData();
                }
            }, [token]);

            const loadData = async () => {
                try {
                    setLoading(true);
                    if (user.role === 'doctor') {
                        const [patientsData, appointmentsData, feesData] = await Promise.all([
                            api.getPatients(token),
                            api.getAppointments(token),
                            api.getFees(token)
                        ]);
                        setPatients(patientsData);
                        setAppointments(appointmentsData);
                        setFees(feesData);
                    } else {
                        const [appointmentsData, feesData] = await Promise.all([
                            api.getAppointments(token),
                            api.getFees(token)
                        ]);
                        setAppointments(appointmentsData);
                        setFees(feesData);
                        
                        const patientData = await fetch(`${API_URL}/patients/${user.patientId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }).then(res => res.json());
                        setPatients([patientData]);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    setLoading(true);
                    setError('');
                    const formData = new FormData(e.target);
                    const data = await api.login(
                        formData.get('email'),
                        formData.get('password'),
                        formData.get('role')
                    );
                    setToken(data.token);
                    setUser(data.user);
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => {
                setToken(null);
                setUser(null);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                setActiveTab('dashboard');
            };

            const openModal = (type, patient = null) => {
                setModalType(type);
                setSelectedPatient(patient);
                setFormData(patient || {});
                setShowModal(true);
                setError('');
                setSuccess('');
            };

            const closeModal = () => {
                setShowModal(false);
                setModalType('');
                setSelectedPatient(null);
                setFormData({});
                setError('');
                setSuccess('');
            };

            const handleFormChange = (field, value) => {
                setFormData({ ...formData, [field]: value });
            };

            const savePatient = async () => {
                try {
                    setLoading(true);
                    setError('');
                    if (selectedPatient) {
                        await api.updatePatient(token, selectedPatient.id, formData);
                        setSuccess('Patient updated successfully');
                    } else {
                        const result = await api.addPatient(token, formData);
                        setSuccess(`Patient added! Login: ${result.credentials.email} / ${result.credentials.password}`);
                    }
                    await loadData();
                    setTimeout(closeModal, 2000);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const deletePatient = async (id) => {
                if (!confirm('Delete this patient? This cannot be undone.')) return;
                try {
                    await api.deletePatient(token, id);
                    await loadData();
                    closeModal();
                } catch (err) {
                    setError(err.message);
                }
            };

            const saveAppointment = async () => {
                try {
                    setLoading(true);
                    setError('');
                    await api.addAppointment(token, formData);
                    setSuccess('Appointment scheduled successfully');
                    await loadData();
                    setTimeout(closeModal, 1500);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const saveFee = async () => {
                try {
                    setLoading(true);
                    setError('');
                    await api.addFee(token, formData);
                    setSuccess('Fee record added successfully');
                    await loadData();
                    setTimeout(closeModal, 1500);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const getTodayAppointments = () => {
                const today = new Date().toISOString().split('T')[0];
                return appointments.filter(apt => apt.date === today);
            };

            const getQueuedAppointments = () => {
                const today = new Date().toISOString().split('T')[0];
                return appointments.filter(apt => apt.date === today && apt.status === 'scheduled');
            };

            const getTotalRevenue = () => {
                return fees.filter(f => f.payment_status === 'paid').reduce((sum, fee) => sum + parseFloat(fee.amount || 0), 0);
            };

            if (!token || !user) {
                return (
                    <div className="login-container">
                        <div className="login-card">
                            <div className="login-header">
                                <h1>üè• Dr. Jahnavi's Clinic</h1>
                                <p>Hospital Management System</p>
                            </div>
                            {error && <div className="error-message">{error}</div>}
                            <form onSubmit={handleLogin}>
                                <div className="form-group">
                                    <label>Login As</label>
                                    <select name="role" required>
                                        <option value="doctor">Doctor</option>
                                        <option value="patient">Patient</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Email / Phone</label>
                                    <input type="text" name="email" required />
                                </div>
                                <div className="form-group">
                                    <label>Password</label>
                                    <input type="password" name="password" required />
                                </div>
                                <button type="submit" className="btn" disabled={loading}>
                                    {loading ? 'Logging in...' : 'Login'}
                                </button>
                            </form>
                            <p style={{marginTop: '20px', textAlign: 'center', color: '#666', fontSize: '12px'}}>
                                Doctor: jahnavi@clinic.com / jahnavi123
                            </p>
                        </div>
                    </div>
                );
            }

            if (loading && patients.length === 0) {
                return <div className="loading">Loading...</div>;
            }

            // Patient Dashboard
            if (user.role === 'patient') {
                const patient = patients[0];
                return (
                    <div className="container">
                        <div className="dashboard">
                            <div className="dashboard-header">
                                <div>
                                    <h2>Patient Portal</h2>
                                    <p>Welcome, {patient?.name}</p>
                                </div>
                                <button className="btn btn-small btn-secondary" onClick={handleLogout}>Logout</button>
                            </div>

                            {error && <div className="error-message">{error}</div>}
                            {success && <div className="success-message">{success}</div>}

                            <div className="stats-grid">
                                <div className="stat-card">
                                    <h4>My Appointments</h4>
                                    <p>{appointments.length}</p>
                                </div>
                                <div className="stat-card">
                                    <h4>Pending Payments</h4>
                                    <p>‚Çπ{fees.filter(f => f.payment_status === 'pending').reduce((sum, f) => sum + parseFloat(f.amount || 0), 0).toLocaleString('en-IN')}</p>
                                </div>
                            </div>

                            <button className="btn btn-small" onClick={() => openModal('appointment')}>Book Appointment</button>

                            <div className="card" style={{marginTop: '20px'}}>
                                <h3>My Information</h3>
                                {patient && (
                                    <>
                                        <div className="info-row">
                                            <span className="info-label">Name:</span>
                                            <span className="info-value">{patient.name}</span>
                                        </div>
                                        <div className="info-row">
                                            <span className="info-label">Age:</span>
                                            <span className="info-value">{patient.age}</span>
                                        </div>
                                        <div className="info-row">
                                            <span className="info-label">Phone:</span>
                                            <span className="info-value">{patient.phone}</span>
                                        </div>
                                    </>
                                )}
                            </div>

                            {patient && (patient.diagnosis || patient.treatment) && (
                                <div className="card">
                                    <h3>Medical History</h3>
                                    {patient.diagnosis && (
                                        <div className="info-row">
                                            <span className="info-label">Diagnosis:</span>
                                            <span className="info-value">{patient.diagnosis}</span>
                                        </div>
                                    )}
                                    {patient.treatment && (
                                        <div className="info-row">
                                            <span className="info-label">Treatment:</span>
                                            <span className="info-value">{patient.treatment}</span>
                                        </div>
                                    )}
                                    {patient.medication && (
                                        <div className="info-row">
                                            <span className="info-label">Medication:</span>
                                            <span className="info-value">{patient.medication}</span>
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="card">
                                <h3>My Appointments</h3>
                                {appointments.length === 0 ? (
                                    <p style={{color: '#666'}}>No appointments</p>
                                ) : (
                                    appointments.map(apt => (
                                        <div key={apt.id} style={{padding: '15px', background: 'white', borderRadius: '8px', marginBottom: '10px', border: '1px solid #e0e0e0'}}>
                                            <p><strong>Date:</strong> {apt.date} at {apt.time}</p>
                                            <p><strong>Status:</strong> {apt.status}</p>
                                            {apt.reason && <p><strong>Reason:</strong> {apt.reason}</p>}
                                        </div>
                                    ))
                                )}
                            </div>

                            <div className="card">
                                {(() => {
                                    const totalDue = fees.filter(f => f.payment_status === 'pending').reduce((s, f) => s + parseFloat(f.amount || 0), 0);
                                    const totalPaid = fees.filter(f => f.payment_status === 'paid').reduce((s, f) => s + parseFloat(f.amount || 0), 0);
                                    const totalBilled = fees.reduce((s, f) => s + parseFloat(f.amount || 0), 0);

                                    const formatDate = (dateStr) => {
                                        if (!dateStr) return '‚Äî';
                                        const d = new Date(dateStr);
                                        return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                                    };

                                    const filtered = fees.filter(f =>
                                        billingFilter === 'all' ? true : f.payment_status === billingFilter
                                    );

                                    return (
                                        <>
                                            <div className="billing-section-header">
                                                <h3>Billing History</h3>
                                                <div className="billing-filter">
                                                    {['all', 'pending', 'paid'].map(f => (
                                                        <button
                                                            key={f}
                                                            className={`filter-btn ${billingFilter === f ? 'active' : ''}`}
                                                            onClick={() => setBillingFilter(f)}
                                                        >
                                                            {f.charAt(0).toUpperCase() + f.slice(1)}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            {fees.length === 0 ? (
                                                <div className="empty-billing">
                                                    <p>No billing records found.</p>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="billing-summary">
                                                        <div className="billing-summary-card total">
                                                            <div className="summary-label">Total Billed</div>
                                                            <div className="summary-amount">‚Çπ{totalBilled.toLocaleString('en-IN')}</div>
                                                        </div>
                                                        <div className="billing-summary-card paid">
                                                            <div className="summary-label">Paid</div>
                                                            <div className="summary-amount">‚Çπ{totalPaid.toLocaleString('en-IN')}</div>
                                                        </div>
                                                        <div className="billing-summary-card pending">
                                                            <div className="summary-label">Due</div>
                                                            <div className="summary-amount">‚Çπ{totalDue.toLocaleString('en-IN')}</div>
                                                        </div>
                                                    </div>

                                                    {totalDue > 0 && (
                                                        <div className="pending-alert">
                                                            ‚ö† You have ‚Çπ{totalDue.toLocaleString('en-IN')} in pending payments. Please pay using UPI below.
                                                        </div>
                                                    )}

                                                    {filtered.length === 0 ? (
                                                        <div className="empty-billing">
                                                            <p>No {billingFilter} records.</p>
                                                        </div>
                                                    ) : (
                                                        filtered.map(fee => (
                                                            <div key={fee.id} className={`fee-row ${fee.payment_status === 'pending' ? 'pending-row' : 'paid-row'}`}>
                                                                <div className="fee-row-left">
                                                                    <div className="fee-service">{fee.service || 'Consultation'}</div>
                                                                    <div className="fee-date">{formatDate(fee.date)}</div>
                                                                    {fee.payment_method && (
                                                                        <div className="fee-method">Paid via {fee.payment_method}</div>
                                                                    )}
                                                                </div>
                                                                <div className="fee-row-right">
                                                                    <div className="fee-amount">‚Çπ{parseFloat(fee.amount).toLocaleString('en-IN')}</div>
                                                                    <div className={`fee-badge ${fee.payment_status}`}>{fee.payment_status}</div>
                                                                </div>
                                                            </div>
                                                        ))
                                                    )}

                                                    {totalDue > 0 && (
                                                        <div className="upi-section">
                                                            <h4>Pay ‚Çπ{totalDue.toLocaleString('en-IN')} via UPI</h4>
                                                            <div className="upi-id">drjahnavi@paytm</div>
                                                            <p style={{fontSize: '12px', color: '#667eea', marginTop: '8px'}}>
                                                                Open any UPI app (PhonePe, GPay, Paytm) and send payment to the above UPI ID. Your doctor will update the status once confirmed.
                                                            </p>
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                        </>
                                    );
                                })()}
                            </div>
                        </div>

                        {showModal && (
                            <div className="modal">
                                <div className="modal-content">
                                    <div className="modal-header">
                                        <h3>Book Appointment</h3>
                                        <button className="close-btn" onClick={closeModal}>&times;</button>
                                    </div>
                                    {error && <div className="error-message">{error}</div>}
                                    {success && <div className="success-message">{success}</div>}
                                    <form onSubmit={(e) => { e.preventDefault(); saveAppointment(); }}>
                                        <div className="form-group">
                                            <label>Date*</label>
                                            <input 
                                                type="date" 
                                                value={formData.date || ''} 
                                                onChange={(e) => handleFormChange('date', e.target.value)}
                                                min={new Date().toISOString().split('T')[0]}
                                                required 
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Time*</label>
                                            <input 
                                                type="time" 
                                                value={formData.time || ''} 
                                                onChange={(e) => handleFormChange('time', e.target.value)}
                                                required 
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Reason</label>
                                            <textarea 
                                                value={formData.reason || ''} 
                                                onChange={(e) => handleFormChange('reason', e.target.value)}
                                            />
                                        </div>
                                        <button type="submit" className="btn" disabled={loading}>
                                            {loading ? 'Booking...' : 'Book Appointment'}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // Doctor Dashboard
            return (
                <div className="container">
                    <div className="dashboard">
                        <div className="dashboard-header">
                            <div>
                                <h2>Dr. Jahnavi's Clinic</h2>
                                <p>Welcome, Dr. {user.name}</p>
                            </div>
                            <button className="btn btn-small btn-secondary" onClick={handleLogout}>Logout</button>
                        </div>

                        {error && <div className="error-message">{error}</div>}
                        {success && <div className="success-message">{success}</div>}

                        <div className="nav-tabs">
                            {['dashboard', 'patients', 'appointments', 'fees'].map(tab => (
                                <button 
                                    key={tab}
                                    className={`nav-tab ${activeTab === tab ? 'active' : ''}`}
                                    onClick={() => setActiveTab(tab)}
                                >
                                    {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                </button>
                            ))}
                        </div>

                        {activeTab === 'dashboard' && (
                            <>
                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <h4>Total Patients</h4>
                                        <p>{patients.length}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h4>Today's Appointments</h4>
                                        <p>{getTodayAppointments().length}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h4>Queue</h4>
                                        <p>{getQueuedAppointments().length}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h4>Total Revenue</h4>
                                        <p>‚Çπ{getTotalRevenue().toLocaleString('en-IN')}</p>
                                    </div>
                                </div>

                                <div className="card">
                                    <h3>Today's Queue</h3>
                                    {getQueuedAppointments().length === 0 ? (
                                        <p style={{color: '#666'}}>No appointments in queue</p>
                                    ) : (
                                        getQueuedAppointments().map((apt, idx) => (
                                            <div key={apt.id} className="queue-item">
                                                <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                    <div>
                                                        <span className="queue-number">#{idx + 1}</span>
                                                        <strong style={{marginLeft: '15px'}}>{apt.patient_name}</strong>
                                                        <p style={{marginLeft: '50px', marginTop: '5px', color: '#666'}}>Time: {apt.time}</p>
                                                    </div>
                                                    <p style={{color: '#666'}}>{apt.patient_phone}</p>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </>
                        )}

                        {activeTab === 'patients' && (
                            <>
                                <button className="btn btn-small" onClick={() => openModal('addPatient')}>Add Patient</button>
                                <div className="patient-list" style={{marginTop: '20px'}}>
                                    {patients.map(patient => (
                                        <div key={patient.id} className="patient-item" onClick={() => openModal('viewPatient', patient)}>
                                            <h4>{patient.name}</h4>
                                            <p><strong>Age:</strong> {patient.age} | <strong>Phone:</strong> {patient.phone}</p>
                                            {patient.diagnosis && <p><strong>Diagnosis:</strong> {patient.diagnosis}</p>}
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}

                        {activeTab === 'appointments' && (
                            <>
                                <button className="btn btn-small" onClick={() => openModal('addAppointment')}>Schedule Appointment</button>
                                <div style={{marginTop: '20px'}}>
                                    {appointments.map((apt, idx) => (
                                        <div key={apt.id} className="card">
                                            <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                <div>
                                                    <h4>{apt.patient_name}</h4>
                                                    <p>Date: {apt.date} | Time: {apt.time}</p>
                                                    <p>Status: {apt.status}</p>
                                                    {apt.reason && <p>Reason: {apt.reason}</p>}
                                                </div>
                                                <span className="queue-number">#{idx + 1}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}

                        {activeTab === 'fees' && (
                            <>
                                <button className="btn btn-small" onClick={() => openModal('addFee')}>Add Fee</button>
                                <div className="card" style={{marginTop: '20px'}}>
                                    <h3>Total Revenue: ‚Çπ{getTotalRevenue().toLocaleString('en-IN')}</h3>
                                </div>
                                <div className="upi-section">
                                    <h4>UPI Payment ID</h4>
                                    <div className="upi-id">drjahnavi@paytm</div>
                                </div>
                                <div style={{marginTop: '20px'}}>
                                    {fees.map(fee => (
                                        <div key={fee.id} className="card">
                                            <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                <div>
                                                    <h4>{fee.patient_name}</h4>
                                                    <p>Service: {fee.service || 'Consultation'}</p>
                                                    <p>Status: <span style={{color: fee.payment_status === 'paid' ? '#2f7d32' : '#d32f2f'}}>{fee.payment_status}</span></p>
                                                    {fee.payment_method && <p>Method: {fee.payment_method}</p>}
                                                </div>
                                                <h3 style={{color: '#667eea'}}>‚Çπ{parseFloat(fee.amount).toLocaleString('en-IN')}</h3>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>

                    {showModal && (
                        <div className="modal">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h3>
                                        {modalType === 'addPatient' && 'Add Patient'}
                                        {modalType === 'viewPatient' && 'Patient Details'}
                                        {modalType === 'addAppointment' && 'Schedule Appointment'}
                                        {modalType === 'addFee' && 'Add Fee'}
                                    </h3>
                                    <button className="close-btn" onClick={closeModal}>&times;</button>
                                </div>

                                {error && <div className="error-message">{error}</div>}
                                {success && <div className="success-message">{success}</div>}

                                {(modalType === 'addPatient' || modalType === 'viewPatient') && (
                                    <form onSubmit={(e) => { e.preventDefault(); savePatient(); }}>
                                        <div className="form-group">
                                            <label>Name*</label>
                                            <input type="text" value={formData.name || ''} onChange={(e) => handleFormChange('name', e.target.value)} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Age*</label>
                                            <input type="number" value={formData.age || ''} onChange={(e) => handleFormChange('age', e.target.value)} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Gender</label>
                                            <select value={formData.gender || ''} onChange={(e) => handleFormChange('gender', e.target.value)}>
                                                <option value="">Select</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Phone*</label>
                                            <input type="tel" value={formData.phone || ''} onChange={(e) => handleFormChange('phone', e.target.value)} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Email</label>
                                            <input type="email" value={formData.email || ''} onChange={(e) => handleFormChange('email', e.target.value)} />
                                        </div>
                                        <div className="form-group">
                                            <label>Address</label>
                                            <textarea value={formData.address || ''} onChange={(e) => handleFormChange('address', e.target.value)} />
                                        </div>
                                        <div className="form-group">
                                            <label>Diagnosis</label>
                                            <textarea value={formData.diagnosis || ''} onChange={(e) => handleFormChange('diagnosis', e.target.value)} />
                                        </div>
                                        <div className="form-group">
                                            <label>Treatment</label>
                                            <textarea value={formData.treatment || ''} onChange={(e) => handleFormChange('treatment', e.target.value)} />
                                        </div>
                                        <div className="form-group">
                                            <label>Medication</label>
                                            <textarea value={formData.medication || ''} onChange={(e) => handleFormChange('medication', e.target.value)} />
                                        </div>
                                        <div className="form-group">
                                            <label>Notes</label>
                                            <textarea value={formData.notes || ''} onChange={(e) => handleFormChange('notes', e.target.value)} />
                                        </div>
                                        <div className="action-buttons">
                                            <button type="submit" className="btn btn-small" disabled={loading}>
                                                {loading ? 'Saving...' : (selectedPatient ? 'Update' : 'Add')}
                                            </button>
                                            {selectedPatient && (
                                                <button type="button" className="btn btn-small btn-danger" onClick={() => deletePatient(selectedPatient.id)}>
                                                    Delete
                                                </button>
                                            )}
                                        </div>
                                    </form>
                                )}

                                {modalType === 'addAppointment' && (
                                    <form onSubmit={(e) => { e.preventDefault(); saveAppointment(); }}>
                                        <div className="form-group">
                                            <label>Patient*</label>
                                            <select value={formData.patient_id || ''} onChange={(e) => handleFormChange('patient_id', e.target.value)} required>
                                                <option value="">Select Patient</option>
                                                {patients.map(p => (
                                                    <option key={p.id} value={p.id}>{p.name} - {p.phone}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Date*</label>
                                            <input 
                                                type="date" 
                                                value={formData.date || ''} 
                                                onChange={(e) => handleFormChange('date', e.target.value)}
                                                min={new Date().toISOString().split('T')[0]}
                                                required 
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Time*</label>
                                            <input type="time" value={formData.time || ''} onChange={(e) => handleFormChange('time', e.target.value)} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Reason</label>
                                            <textarea value={formData.reason || ''} onChange={(e) => handleFormChange('reason', e.target.value)} />
                                        </div>
                                        <button type="submit" className="btn" disabled={loading}>
                                            {loading ? 'Scheduling...' : 'Schedule'}
                                        </button>
                                    </form>
                                )}

                                {modalType === 'addFee' && (
                                    <form onSubmit={(e) => { e.preventDefault(); saveFee(); }}>
                                        <div className="form-group">
                                            <label>Patient*</label>
                                            <select value={formData.patient_id || ''} onChange={(e) => handleFormChange('patient_id', e.target.value)} required>
                                                <option value="">Select Patient</option>
                                                {patients.map(p => (
                                                    <option key={p.id} value={p.id}>{p.name} - {p.phone}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Amount (‚Çπ)*</label>
                                            <input type="number" value={formData.amount || ''} onChange={(e) => handleFormChange('amount', e.target.value)} required min="0" />
                                        </div>
                                        <div className="form-group">
                                            <label>Service</label>
                                            <input type="text" value={formData.service || ''} onChange={(e) => handleFormChange('service', e.target.value)} placeholder="e.g., Consultation, X-Ray" />
                                        </div>
                                        <div className="form-group">
                                            <label>Payment Status*</label>
                                            <select value={formData.payment_status || 'pending'} onChange={(e) => handleFormChange('payment_status', e.target.value)}>
                                                <option value="pending">Pending</option>
                                                <option value="paid">Paid</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Payment Method</label>
                                            <select value={formData.payment_method || ''} onChange={(e) => handleFormChange('payment_method', e.target.value)}>
                                                <option value="">Select</option>
                                                <option value="Cash">Cash</option>
                                                <option value="UPI">UPI</option>
                                                <option value="Card">Card</option>
                                                <option value="Net Banking">Net Banking</option>
                                            </select>
                                        </div>
                                        <div className="upi-section">
                                            <h4>UPI ID</h4>
                                            <div className="upi-id">drjahnavi@paytm</div>
                                        </div>
                                        <button type="submit" className="btn" disabled={loading}>
                                            {loading ? 'Adding...' : 'Add Fee'}
                                        </button>
                                    </form>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
